# Request For Comments 3: 工作项

Version: 7 (2025-04-12 15:05:00)

最近变更：

- Version 7

  - US1.5.1：注册时要求填写姓名、身份证号
  - US1.5.2：移除了首次登录判断逻辑
  - US1.5.4：个人资料界面应当展示姓名、身份证号，且应当脱敏处理

- Version 6
  - 新增了 Task 内容
  - 新增了预估时间
  - 删除了原 US1.3.2：作为乘客，我想在提交订单后快速得到响应，以便于确认支付是否成功（US1.1.6 已实现）
  - 删除了原 US1.3.3：作为乘客，我想能够确认订单是否成功，以便安排行程（FE1.4 已实现）
  - 删除了原 US1.3.4：作为乘客，我想对于失败的订单，能够及时获得退款，以便进行其它安排（新 US1.3.2 已实现）
  - 删除了原 EP4：保障用户隐私与数据安全（已实现）
  - 新增了 US1.3.2: 作为乘客，我想能够预订火车订单，以便安排行程
  - 新增外卖预订功能
- Version 5
  - 明确了订单状态
  - US1.2.1、US3.1.1：新增按城市查询功能
  - US1.1.4：添加“用户也可选择使用用户密码验证”
  - US1.4.2：移除“支付订单”的错误描述
  - US2.1.1：明确不进行住宿时间筛选时，显示哪些房间
  - US2.1.1、US2.1.3：酒店最长只能预订 7 天（否则，后端判断复杂度没有上界）
  - US2.1.3：明确预订列表实现要求
  - US2.2.1：支持按起始到达站查询、增加外卖点餐功能
  - US2.2.2：明确预订列表实现要求
  - US3.2.1：返回的推荐信息中，“平均消费”改为“最低价格”
- Version 4
  - 明确了“交易”与“订单”的区别
- Version 3
  - 明确了“始发站”、“终到站”、“起始站”、“到达站”的区别
  - 约定了系统内货币
  - US1.2.1、US3.1.1：明确了车票预订时默认显示的价格为二等座价格
  - US1.2.1、US3.1.1：显示每种座位的价格
- Version 2
  - FE1.5 新增 US1.5.3，退出登录
  - FE1.5 新增 US1.5.4，查看与设置个人资料

缩写释义：

- EP：Epic，最大粒度的业务目标，代表需要**多个迭代周期**才能完成的战略级需求，聚焦“为什么做”，而非“如何做”
- FE：Feature，Epic 下的具体功能模块，代表用户可感知的独立能力，可作为一个完整功能上线
- US：User Story，从用户视角 描述的、可在一个迭代内（通常 1-3 天）完成的独立需求单元，验收标准明确：定义完成的具体条件
- TSK：Task，Story 下的具体技术工作项，由开发者拆解并分配给个人，通常 0.5-2 天完成

关于火车站点的约定：

- 始发站（Origin Station）：车次路线的第一个站，列车从此站发车
- 终到站（Terminal Station）：车次路线的最后一个站，列车运行至此结束
- 起始站（Departure Station）：乘客实际开始乘车的站点
- 到达站（Arrival Station）：乘客实际结束乘车的站点

关于货币的约定：

- 超级货币（Super Credit），缩写 SC

关于交易和订单的约定：

- 一笔订单明确对应一个服务，例如：一张火车票、一个房间预订、一份火车餐
- 交易对应一笔支付，一个交易可包含多个订单，例如：添加多个乘车人后点击“预订”，产生多个订单，但只有一个交易；交易有“未支付”、“已支付”两种状态
- 只能取消“订单”，而不能直接取消“交易”。若需“取消”交易，需通过退款交易实现。
- 取消订单、失败订单的退款通过新的退款交易返还，原始支付交易不变

关于订单状态的约定：

- 未支付（Unpaid）：订单已经生成，还未支付
- 已支付（Paid）：订单已经生成，且支付成功，此时订单将进入后端消息队列；系统处理完成后，根据实际情况进入“未出行”或“失败”状态（如是否有可用座位）
- 未出行（Ongoing）：订单已被后端处理，且成功（例如，火车订票有符合条件的座位，订票成功），还没有出行
- 行程中（Active）：行程正在进行（例如，火车订票已经过始发站，还未到达终到站）
- 已完成（Completed）：行程已经完成（例如，火车订票已到达终到站）
- 失败（Failed）：订单已被后端处理，且失败（例如，火车订票没有符合条件的座位，订票失败）
- 已取消（Canceled）：订单被用户取消

关于火车站点的约定：

- 始发站（Origin Station）：车次路线的第一个站，列车从此站发车
- 终到站（Terminal Station）：车次路线的最后一个站，列车运行至此结束
- 起始站（Departure Station）：乘客实际开始乘车的站点
- 到达站（Arrival Station）：乘客实际结束乘车的站点

关于货币的约定：

- 超级货币（Super Credit），缩写 SC

关于交易和订单的约定：

- 一笔订单明确对应一个服务，例如：一张火车票、一个房间预订、一份火车餐
- 交易对应一笔支付，一个交易可包含多个订单，例如：添加多个乘车人后点击“预订”，产生多个订单，但只有一个交易；交易有“未支付”、“已支付”两种状态
- 只能取消“订单”，而不能取消“交易”
- 取消订单、失败订单的退款通过新的退款交易返还，原始支付交易不变

## EP1：构建核心火车票务系统（3 周）

价值：实现用户从搜索到支付的全流程购票能力。
范围：车次查询、余票计算、座位选择、订单管理（仅实现直达车票购买）。

### FE1.1：缴费系统（5 天）

功能点：

- 充值
- 余额显示
- 交易状态：已支付/未支付
- 触发：用户完成支付时，触发订单状态改变

#### US1.1.1：作为用户，我想进行充值，以便购买其它服务

验收标准：

- 在充值界面可输入充值金额（1 SC 至 2000 SC）
- 点击充值按钮后，可返回充值成功/失败的结果，失败时显示具体原因

##### TSK1.1.1A：后端：交易系统开发

工作内容：

- 建立数据库`transaction`表的模型
- 封装交易相关操作：
  - 充值
  - 查询余额
  - 生成交易
  - 支付交易
  - 生成退款交易
  - 历史交易查询
  - 订单触发
- 编写单元测试覆盖边界条件

##### TSK1.1.1B：后端：充值 API 开发

工作内容：

- 实现`/api/payment/recharge`
- 充值金额校验

##### TSK1.1.1C：后端：全局状态 API 开发

工作内容：

- 实现`/api/general/mode`
  - 提供在后端其它处理函数中获取当前运行模式的接口
- 实现`/api/general/city_stations`

##### TSK1.1.1D：前端：充值界面实现

工作内容：

- 充值金额输入
- 充值金额校验
- 充值按钮逻辑
- 请求发送以及错误处理

#### US1.1.2：作为用户，我想查询当前余额，以便决定是否需要充值

验收标准：

- 在“个人”页面，可显示实时余额

##### TSK1.1.2A：后端：查询余额 API 开发

工作内容：

- 实现`/api/payment/balance`接口

##### TSK1.1.2B：前端：余额显示

工作内容：

- 在“个人”页面适当位置显示余额
- 将余额保存到前端全局状态，避免反复调用 API 查询

#### US1.1.3：作为用户，我想在购买服务需要缴费时，显示总金额，并请求确认，以便决定是否购买

验收标准：

- （仅供前期调试使用）当前端及后端运行在 Debug 模式时，点击“测试购买”按钮并输入购买金额，弹出支付界面，并显示购买金额。
- 若余额充足，“支付”按钮显示为可点击状态
- 若余额不足，“支付”按钮显示为不可点击状态，鼠标悬停时提示余额不足

##### TSK1.1.3A：后端：Debug 模式实现

工作内容：

- 实现`/api/general/mode`接口
- 允许通过环境变量指定运行模式
- 提供接口用于在执行其它操作时获取当前运行模式

##### TSK1.1.3B：后端：测试购买实现

工作内容：

- 实现`/api/transaction/generate`

##### TSK1.1.3C：后端：交易支付实现

工作内容：

- 实现`/api/transaction/pay/{transaction_id}`

##### TSK1.1.3D：前端：运行模式判断

工作内容：

- 根据后端的响应，切换不同的显示模式
- 将运行模式存入全局状态，避免反复调用 API 查询

##### TSK1.1.3E：前端：Debug 专用页面实现

工作内容：

- 实现 Debug 专用页面，入口仅在 Debug 模式下显示

##### TSK1.1.3F：前端：测试购买实现

工作内容：

- 在 Debug 专用页面中显示测试购买入口
- 购买金额校验
- 请求发送及错误处理

##### TSK1.1.3G：前端：支付页面实现

工作内容：

- 实现支付页面的 Vue 组件，该组件应当能在任何页面上展示
- 显示购买金额
- 显示支付按钮，并根据余额判断是否能够支付（应当使用全局状态中的余额，不要调用 API 获取）
- 请求发送及错误处理
- 支付后，按照支付金额更新全局状态中的余额
- 支付时要求输入用户密码，并给支付密码支付留出接口

#### US1.1.4：作为用户，我想支付时，需要使用 6 位数字支付密码做验证，以便保证便捷性和安全性

验收标准：

- 在“个人”页面，可设置 6 位数字支付密码（要求使用用户密码验证）
- 在支付界面，点击“支付”按钮后，要求输入 6 位数字支付密码；用户也可选择使用用户密码验证
- 若连续 5 次输入错误，则要求输入用户密码，并给出重置密码选项

##### TSK1.1.4A：后端：设置支付密码实现

工作内容：

- 实现`/api/payment/payment_password`
- 支付密码校验
- 设置新的支付密码后，“支付密码错误尝试次数”应当清零
- 设置新的支付密码后，将全局状态“使用支付密码”设为`true`

##### TSK1.1.4B：前端：设置支付密码实现

工作内容：

- 在“个人”页面适当位置显示设置支付密码按钮
- 实现输入 6 位数字支付密码的 UI，要求：用图形明确告知用户密码为 6 位、当前正在设置哪一位（参考手机 6 位密码解锁）
- 要求输入用户密码
- 请求发送及错误处理

##### TSK1.1.4C：前端：是否使用支付密码判断

工作内容：

- 在用户登录时，通过“获取个人资料”API 获取用户是否设置了支付密码。若设置，将全局状态“使用支付密码”设为`true`；否则，设为`false`
- 在用户支付时，若全局状态“使用支付密码”为`true`，则默认使用支付密码进行认证，用户也可切换到使用用户密码认证；否则，使用用户密码进行认证，且不能切换到使用支付密码验证

##### TSK1.1.4D：前端：支付密码错误尝试过多判断

工作内容：

- 在调用“支付订单”API 时，若返回代码为 11003，将全局状态“使用支付密码”设为`false`，并给出重置支付密码选项

#### US1.1.5：作为用户，我想在购买服务需要缴费时，可以暂不进行支付，并在稍后再支付，以便进行充值等其它操作

验收标准：

- 用户可随时关闭支付界面
- 用户可在订单中的“待支付”类别中看到未支付的交易，以及其关联的订单
- 用户可点击未支付的交易，重新打开支付界面进行支付

##### TSK1.1.5A：后端：订单列表、订单详情实现

工作内容：

- 实现`/api/order/list`

##### TSK1.1.5B：前端：简易订单管理实现

工作内容：

- 对于订单管理页面，本任务只要求如下内容：
  - 将订单按所属的交易分组，相同交易的多个订单放置在一个列表中
  - 显示各个交易的状态、总金额、交易 ID、关联的订单：订单 ID、金额
  - 可分类查看未支付、已支付的交易；对于未支付的交易，显示“支付”按钮
  - 点击“支付”按钮，弹出支付界面进行支付
- 为实现 FE1.4 中的订单管理功能预留接口

#### US1.1.6：作为用户，我想完成支付后，相关订单能够得到执行，以便自己的需求得到满足

验收标准：

- 支付完成后，订单变为“已支付”状态
- 已支付订单被加入到消息队列中，待后端进行购票、预订酒店等实际处理

##### TSK1.1.6A：后端：实现通过消息队列进行订单处理

工作内容：

- 检测到用户支付交易后，将关联的订单加入消息队列；修改交易状态为“已支付”
- 实现从消息队列中逐个取出订单的功能
- 从消息队列中取出订单时，再次检查订单状态（是否已经取消）
- 本任务只要求取出订单并向 RabbitMQ 服务器发送 ACK，不要求实际处理订单，但应当为之后的实际处理预留接口

##### TSK1.1.6B：前端：订单处理告知

工作内容：

- 订单支付后（即，调用“支付订单”API 获得成功的响应后），告知用户订单已加入处理队列

### FE1.2：实时车次查询引擎（5 天）

功能点：

- 条件筛选：只看有座位、只看高铁/动车、只看普通车
- 排序：旅途总时长、出发时间早晚、价格
- 余票缓存

#### US1.2.1：作为乘客，我想查询请求能返回需要的信息，并够快速得到响应，以便于合理规划

验收标准：

- 选择“火车票”选项卡，应当切换到火车票购票界面
- 选择“直达”选项，进入直达查询模式
- 选择起始站、到达站、出发时间并点击查询后，响应时间<1s
- 选择出发城市、到达城市、出发时间并点击查询后，响应时间<1s
- 查询结果界面应当包含如下内容：
  - 筛选选项：只看高铁、只看普通车、只看有票
  - 排序选项：按出发时间、按行程时间、按价格
  - 车次信息：
    - 起始站、离开“起始站”时间；到达站、到达“到达站”时间
    - 始发站、始发时间；终到站、终到时间
    - 车次号
    - 行程时间
    - 价格（当前余票的最低票价）
    - 车次信息（所有途径站点，每个站点的到达时间与出发时间）
    - 剩余座位信息：
      - 每种座位类型的剩余数量，每种座位的价格
      - 对于剩余数量>20% 的，显示为有票（绿色）；<20% 的，显示为剩余张数（黄色）；无剩余座位的，显示为无票（红色）

##### TSK1.2.1A：搜集/建立数据

工作内容：

- 搜集/建立如下数据（可使用实际数据，或编写数据）：
  - 城市：至少 20 个
  - 车站：至少 100 个
  - 车型：要求至少涵盖高铁（G）、动车（D）、特快（T）、普快（K）
  - 车型座位信息：对所有车型，要求按座位类型（只要求对应车型存在的座位，不要求卧铺、站票）从 0 开始给座位编号（即，每种座位类型分别从 0 开始编号），区分座位位置（"A"）并建立`(车型，座位类型，座位位置，编号) -> (人类可读的座位信息（例如，03车 10A 二等座），价格)`的映射（注意，相同座位类型，不同座位位置不重新从 0 开始编号）
  - 车次信息：对每个车次（例如，G53）：
    - 车型
    - 从始发站到终到站的路线信息：
      - 始发时间：不含日期
      - 对每个站点：顺序编号（始发站为 0，之后依次递增），到达时间、离开时间
        - 到达时间、离开时间用“距离始发时间的秒数”记录（这样，即使行程跨越了 1 天甚至 2 天，也可正常计算）
- 信息保存要求用 JSON 格式，并符合`./RFC/attachment/RFC3/TSK1.2.1A.ts`（Typescript）中的要求
  - 对于 Typescript 中的每个 schema，要求使用单独的 JSON 文件保存，例如：`type CitySchema = xxx`的对应内容保存到`city.json`中

##### TSK1.2.1B：后端：车次查询系统基本模型与接口

工作内容：

- 建立数据库`station`表的模型
- 建立数据库`city`表的模型
- 建立数据库`train`表的模型
- 建立数据库`route`表的模型
- 建立数据库`train_type`表的模型
- 建立数据库`seat_type`表的模型
- 建立数据库`occupied_seat`表的模型
- 建立数据库`seat_type_mapping`表的模型
- 建立上述表之间的关系
- 实现如下操作：
  - 添加城市、添加车站、删除城市、删除车站
  - 给定城市，查询该城市的车站列表
  - 添加车型及座位信息、删除车型及座位信息
  - 添加车次、删除车次
- 注意删除需判断是否破坏参照完整性，并允许通过参数递归删除
- 能加载 TSK1.2.1A 中的数据，并能增量加载
- 编写单元测试覆盖边界条件

##### TSK1.2.1C：后端：实现余票缓存机制

工作内容：

- 建立数据库`train_remain_count`表的模型
- 使用恰当的方式更新`train_remain_count`表的内容，使其与实际情况保持一致
- 保留供订票逻辑调用的接口
- 编写单元测试覆盖边界条件

##### TSK1.2.1D：后端：实现直达车次查询接口

工作内容：

- 实现`/api/train/schedule/query_direct`
- 要求将查询过程模块化
- 对于每个模块，编写单元测试覆盖边界条件

##### TSK1.2.1E：前端：编写直达车次查询页面

工作内容：

- 选择“火车票”选项卡，应当切换到火车票购票界面
- 实现“直达”查询，并为“中转”查询预留切换方式
- 实现选择起始站、到达站、起始城市、到达城市的功能：应当有输入框，并有下拉菜单
  - 应当能按拼音首字母、拼音全拼、中文筛选，下拉菜单实时显示符合筛选条件的内容
  - 下拉菜单应有层次结构：（省份）->城市->（车站）
- 实现选择出发日期功能：应当使用日期选择器，同时允许直接输入 MMDD 格式（例如，0405）进行选择
- 为筛选、排序功能预留页面位置及接口
- 查询后，应当显示符合条件的车次列表，对每个车次：
  - 起始站、到达站
  - 始发站、终到站
  - 离开“起始站”时间、到达“到达站”时间：只显示时间，不显示日期；若跨越了一天，在到达“到达站”时间上用（+1 等上标标识，参见 12306）
  - 始发时间、终到时间：只显示时间，不显示日期；若跨越了一天，在到达“到达站”时间上用（+1 等上标标识，参见 12306）
  - 车次号
  - 行程时间：应当显示“XX 时 XX 分”，若小于 1 小时，显示“XX 分”，若大于 1 天，仍显示“XX 时 XX 分”
  - 价格（当前余票的最低票价）
  - 剩余座位信息：
    - 座位类别
    - 对于剩余数量>20% 的，显示为有票（绿色）；<20% 的，显示为剩余张数（黄色）；无剩余座位的，显示为无票（红色）
- 车次列表应当分页，并能选择每页展示数量
- 空结果时显示友好提示
- 请求发送以及错误处理

#### US1.2.2：作为乘客，我想按出发时间排序车次，以便快速找到最早班次

验收标准：

- 车次列表默认按出发时间升序排列
- 支持切换为按旅途总时长、价格排序
- 排序响应时间<200ms

##### TSK1.2.2A：前端：编写按出发时间排序逻辑

工作内容：

- 车次列表默认按出发时间升序排列
- 实现切换为按旅途总时长、价格排序的功能

#### US1.2.3：作为乘客，我想能够只查看有余票的车次，以便于安排行程

验收标准：

- 车次列表默认显示所有车次及剩余座位数量（按座位类别分）
- 支持切换为仅显示有剩余座位的车次
- 空结果时显示友好提示

##### TSK1.2.3A：前端：编写仅显示有余票车次逻辑

工作内容：

- 车次列表默认显示所有车次
- 支持切换为仅显示有剩余座位的车次

#### US1.2.4：作为商务旅客，我想过滤只看高铁车次，避免浪费时间

验收标准：

- 筛选栏包含"高铁"选项
- 选择后列表仅显示 G/C/D 字头车次
- 空结果时显示友好提示

##### TSK1.2.4A：前端：编写仅显示有高铁车次逻辑

工作内容：

- 车次列表默认显示所有车次
- 支持切换为仅 G/C/D 字头车次

### FE1.3：高并发购票系统（5 天）

功能点：

- 保证数据一致性
- 处理大量并发请求
- 失败通知与回滚机制

#### US1.3.1：作为乘客，我想能预先设定乘车人信息、偏好的座位等，以便于在实际购票时不耽误时间

验收标准：

- 在“个人”界面，应当能为每个乘车人设置姓名、身份证号、偏好座位等信息
- 在提交订单时，应默认按设置好的乘车人信息进行选择，同时允许手动修改
- 在用户第一次使用时，应当告知相关功能的存在

##### TSK1.3.1A：后端：实现个人信息功能

工作内容：

- 实现`GET /api/user/personal_info`
- 实现`POST /api/user/personal_info`

##### TSK1.3.1B：前端：实现个人信息显示功能

工作内容：

- 在“个人”界面，提供进入个人信息设置页面的入口
- 在个人信息设置页面，显示每个乘车人的姓名、身份证号、偏好座位
- 身份证号应当脱敏处理
- 偏好座位应当采用图形方式显示，展示其位于一排座位中的哪个位置
- 请求发送以及错误处理
- 用户登录时，应发起个人信息查询，并将乘车人信息保存到前端全局状态，避免反复调用 API 查询
  - 但是，从“个人”界面点击进入个人信息设置页面时，应当发起查询并更新前端全局状态

##### TSK1.3.1C：前端：实现个人信息新增、修改、删除功能

工作内容：

- 在个人信息设置界面，允许对个人信息进行新增、修改、删除
- 新增：必须设置姓名、身份证号，可不设置偏好座位
  - 检查身份证号是否合法（只要求检查格式是否正确、根据校验位进行校验）
- 修改：只允许修改偏好座位
- 请求发送以及错误处理
- 更新存储个人信息的全局状态

#### US1.3.2：作为乘客，我想能够预订火车订单，以便安排行程

##### TSK1.3.2A：后端：火车票预订系统基本模型与接口

工作内容：

- 建立数据库`train_order`表的模型
- 实现如下操作：
  - 添加火车票订单：未支付状态
  - 执行火车票订单：支付触发后，尝试执行该订单
    - 若成功，更新`occupied_seat`、`train_remain_count`表，更新订单状态
    - 若失败，返回错误，暂不不执行退款逻辑，由调用者判断
  - 取消订单：更新`occupied_seat`、`train_remain_count`表，更新订单状态
- 注意操作原子性
- 编写单元测试覆盖边界条件

##### TSK1.3.2B：后端：火车订单预订

工作内容：

- 实现`/api/train/order/new`
- 检查订单是否合法
- 当交易支付后，触发：
  - 单笔订单处理
  - 多笔订单处理
  - 失败回滚
  - 退款逻辑
- 对于每个模块，编写单元测试覆盖边界条件

##### TSK1.3.2C：前端：火车订单预订

工作内容：

- 在火车票购票界面，点击“预订”后，弹出购票悬浮窗
- 显示已添加的乘车人信息，允许一键加入预订订单
  - 用户登录/修改乘车人信息时，保存/更新前端全局状态，避免反复调用 API 查询
- 发送预订请求以及错误处理
  - 若请求成功，将收到交易 ID，以此显示支付界面
  - 若请求失败，提示用户稍后再试

### FE1.4：订单状态管理（4 天）

功能点：

- 取消订单：取消条件判断（发车时间、是否以及取消过）
- 历史订单查询
- 应具有可拓展性，满足之后酒店、火车餐的订单管理

#### US1.4.1 作为乘客，我想查询行程（未结束的订单），以便安排行程

验收标准：

- 在“订单”界面，默认按时间做排序
- 未结束的订单、已经结束的订单、失败的订单，三者在视觉上应该有所区分
- 将来的行程独立成“行程”模块，显示账号本人的行程信息，未出行与已完成在视觉上有所区分

##### TSK1.4.1A：前端：订单解析

工作内容：

- 在“简易订单管理实现”的基础上，实现如下内容：
  - 火车票订单解析：对于火车票订单，额外显示如下内容：
    - 删除订单 ID 的显示
    - 车次
    - 离开起始站时间（出发时间）
    - 乘车人姓名
    - 人类可读的座位号
  - 酒店订单解析：
    - 酒店名称
    - 旅客姓名
    - 人类可读的房间类型
  - 火车餐订单解析：
    - 车次
    - 用餐“时间”
    - 人类可读的餐品名称
- 请求发送以及错误处理

##### TSK1.4.1B：前端：订单排序与筛选

工作内容：

- 按订单创建时间对订单进行排序
- 使用恰当的视觉表达方式区分不同订单状态
- 用户可筛选只显示某种类型的订单
- 结果为空时友好提示

##### TSK1.4.1C：前端：行程模块

工作内容：

- 在订单界面，可切换到“行程”选项卡
- 仅显示本人的订单信息
- 不显示关联的交易，只显示订单
- 按当前时间将订单分为“已出行”、“未出行”，并用不同的视觉表达方式区分
- 按时间顺序显示用户行程计划

#### US1.4.2 作为乘客，我想能够查看订单详情，以便进行核对

验收标准：

- 对于“订单”界面的每笔订单，点击后应当能进入对应的“订单详情”界面
- “订单详情”界面应含有如下信息：
  - 订单状态：详见“关于订单状态的约定”
  - 支付时间
  - 订单类型：火车票、酒店预订、火车餐饮
  - 订单号
  - 交易号
  - 订单详情：
    - 火车票：车次、离开起始站时间、乘车人、座位号、金额
    - 酒店预订：酒店名称、旅客名、房间类型、住宿时间、金额
    - 火车餐预订：车次、用餐人、用餐时间、菜品、金额
  - 订单操作按钮：
    - 对于“已支付”、“未出行”（且距离出行时间大于约定值）的订单，显示取消订单按钮
    - 对于“未出行”（且距离出行时间小于约定值）、“行程中”、“已完成”，显示不可点击的取消订单按钮，且显示不可取消原因。
    - 对于“失败”、“已取消”的订单，不显示按钮

##### TSK1.4.2A：前端：实现订单详情显示

工作内容：

- 实现点击订单页面的订单，进入订单详情页面的功能
- “订单详情”界面应含有如下信息：
  - 订单状态：详见“关于订单状态的约定”
  - 支付时间
  - 订单类型：火车票、酒店预订、火车餐饮
  - 订单号
  - 交易号
  - 订单详情：
    - 火车票：车次、离开起始站时间、乘车人、座位号、金额
    - 酒店预订：酒店名称、旅客名、房间类型、住宿时间、金额
    - 火车餐预订：车次、用餐人、用餐时间、菜品、金额
- 预留“取消订单”操作的接口

#### US1.4.3 作为乘客，我想能够取消订单，以便应对行程变更

验收标准：

- 对于符合条件的订单，能点击“取消订单”按钮进行取消操作（详见 US1.4.2）

##### TSK1.4.3A：前端：实现取消订单功能

工作内容：

- 在订单详情界面，实现如下内容：
- 订单操作按钮：
  - 对于“已支付”、“未出行”（且距离出行时间大于约定值）的订单，显示取消订单按钮
  - 对于“未出行”（且距离出行时间小于约定值）、“行程中”、“已完成”，显示不可点击的取消订单按钮，且显示不可取消原因。
  - 对于“失败”、“已取消”的订单，不显示按钮
- 实现取消订单逻辑
- 请求发送与错误处理

### FE1.5：用户注册与登录（2 天）

功能点：

- 用户注册与登录
- 用户注销
- 用户个人资料管理

#### US1.5.1：作为新用户，我想能够注册账号，以便使用服务

验收标准：

- 注册需填写手机号、用户名、密码、确认密码、姓名、身份证号
- 自动跳转至登录界面

##### TSK1.5.1A：后端：实现用户管理基本功能和接口

工作内容：

- 建立数据库`user`表的模型
- 实现如下操作：
  - 新增用户
  - 删除用户：递归地删除所有用户有关信息
  - 设置用户密码
  - 设置用户支付密码
  - 设置支付密码尝试错误次数
  - 设置个人资料
- 实现用户会话管理（不持久化保存到数据库）：
  - 用户登录
  - 用户注销
  - 判断 session_id 是否合法
  - 由 session_id 获取对应的用户
- 编写单元测试覆盖边界条件

##### TSK1.5.1B：后端：实现用户注册功能

工作内容：

- 实现`/api/user/register`

##### TSK1.5.1C：前端：未登录首页与用户注册界面

工作内容：

- 在用户没有登录时，系统自动跳转到未登录首页
  - 显示项目名称、登录按钮、注册按钮
- 实现注册界面
  - 要求填写手机号、用户名、密码、确认密码、姓名、身份证号
  - 检查手机号是否合法
  - 检查确认密码和密码是否一致
  - 检查身份证号是否合法
  - 请求发送与错误处理
- 注册完成后，自动跳转到登录界面，并自动填充用户名

#### US1.5.2：作为用户，我想能够登录账号，以便使用服务

验收标准：

- 填写正确的手机号、密码后，成功登录平台

##### TSK1.5.2A：后端：实现用户登录功能

工作内容：

- 实现`/api/user/login`
- 为登录成功的用户设置并存储 session_id

##### TSK1.5.2B：前端：实现用户登录界面

工作内容：

- 实现登录界面
  - 要求填写用户名、密码
  - 请求发送与错误处理

##### TSK1.5.3C：前端：登录状态管理

工作内容：

- 设置全局状态，记录当前是否成功登录
- 若未成功登录，自动跳转到未登录首页
- 若在请求中收到状态码为 403，类型为“会话无效”的响应，将全局状态设置为未成功登录

#### US1.5.3：作为用户，我想能够退出账号，以便切换其它账号

验收标准：

- 点击“个人”选项卡，可退出当前登录用户
- 退出后回到未登录状态

##### TSK1.5.3A：后端：实现退出登录功能

工作内容：

- 实现`/api/user/logout`

##### TSK1.5.3B：前端：实现退出登录逻辑

工作内容：

- 在“个人”页面，新增“退出登录”按钮
- 请求发送与错误处理
- 退出登录后，自动跳转到未登录首页

#### US1.5.4：作为用户，我想能够查看与设置个人资料，以便更好地使用服务

验收标准：

- 点击“个人”选项卡，进入个人资料界面
- 个人资料界面应当包含如下信息：
  - 用户名
  - 性别（选填）
  - 年龄（选填）
  - 手机号（应当进行脱敏处理）
  - 邮箱（应当进行脱敏处理）
  - 设置按钮：点击可修改上述个人资料中的：性别、年龄、手机号、邮箱
  - 姓名（应当进行脱敏处理）
  - 身份证号（应当进行脱敏处理）

##### TSK1.5.4A：后端：实现个人资料获取与设置功能

工作内容：

- 实现`GET /api/user/user_info`
- 实现`POST /api/user/user_info`

##### TSK1.5.4B：前端：实现个人资料显示与设置界面

工作内容：

- 点击“个人”选项卡，进入个人资料界面
- 个人资料界面应当包含如下信息：
  - 用户名
  - 性别（选填）
  - 年龄（选填）
  - 手机号（应当进行脱敏处理）
  - 邮箱（应当进行脱敏处理）
  - 姓名（应当进行脱敏处理）
  - 身份证号（应当进行脱敏处理）
  - 设置按钮：点击可修改上述个人资料中的：性别、年龄、手机号、邮箱
- 请求发送与错误处理

## EP2：打造一站式旅游服务平台（2 周）

价值：整合火车票 + 酒店预订 + 火车餐购买服务，完善通知功能，提升用户粘性。
范围：酒店搜索、酒店推荐、酒店详情、酒店预订、酒店评分与评价、火车餐预订、通知功能。

### FE2.1：酒店服务（6 天）

功能点：

- 高级搜索：查询酒店名称、城市
- 排序：根据价格、评分排序
- 酒店详情：查看用户评价以及评分、总体评分，住过（预订且未退订）的用户可发表评论并评分
- 酒店预订：显示每种类型房间的剩余量以及价格，并能进行预订操作
- 整合之前的订单管理系统

#### US2.1.1 作为旅客，我想按照酒店名称、城市查询酒店，以便了解目的地附近的酒店信息

验收标准：

- 选择“酒店”选项卡，应当切换到酒店预订界面
- 在搜索框左侧，应当能选择目的城市/目的火车站
  - 应当能通过下拉列表直接选择，
  - 并且能输入拼音首字母、拼音全拼、中文进行搜索
- 在搜索框中，可输入酒店名称进行搜索
  - 应当允许搜索框中不输入任何内容
  - 应当在未输入内容时，在搜索框中以默认文字提示用户可以不输入内容直接搜索
- 查询结果默认应当按评分排序
- 查询结果界面默认应当包含如下内容：
  - 排序条件：按评分、按价格、按订购人次
  - 筛选条件：
    - 住宿时间：起始--结束（最长不超过 7 天）
  - 未进行筛选时，酒店有任意类型的空闲房间即在查询结果中包含该酒店；有筛选条件时，只有有符合筛选条件的房间的才显示
  - 酒店概览信息：
    - 酒店名称
    - 酒店图片
    - 酒店评分以及评分人数
    - 酒店累计预订人次
    - 酒店价格（若未进行筛选，则显示最低价格；若进行筛选，显示符合条件的最低价格；注：若不按住宿时间筛选，默认只要 7 天内有空余就显示）

##### TSK2.1.1A：搜集/建立数据

工作内容：

- 搜集/建立如下数据（可使用实际数据，或编写数据）：
  - 酒店：至少 20 个
- 信息保存要求用 JSON 格式，并符合`./RFC/attachment/RFC3/TSK2.1.1A.ts`（Typescript）中的要求
  - 对于 Typescript 中的每个 schema，要求使用单独的 JSON 文件保存，例如：`type CitySchema = xxx`的对应内容保存到`city.json`中

##### TSK2.1.1B：后端：酒店查询系统基本模型与接口

工作内容：

- 建立数据库`hotel`表的模型
- 建立数据库`hotel_room_type`表的模型
- 建立数据库`occupied_room`表的模型
- 建立数据库`hotel_rating`表的模型
- 建立上述表之间的关系
- 部署 MinIO 对象存储
- 实现如下操作：
  - 上传对象到 MinIO 对象存储
  - 从 MinIO 对象存储中删除对象
  - 添加酒店、删除酒店
  - 添加、修改、删除酒店房间类型
  - 预订酒店、取消预订酒店
  - 添加评价、删除评价
- 注意删除需判断是否破坏参照完整性，并允许通过参数递归删除
- 能加载 TSK2.1.1A 中的数据，并能增量加载
- 编写单元测试覆盖边界条件

##### TSK2.1.1C：后端：实现剩余房间缓存机制

工作内容：

- 建立数据库`hotel_remain_count`表的模型
- 使用恰当的方式更新`hotel_remain_count`表的内容，使其与实际情况保持一致
- 保留供酒店预订逻辑调用的接口
- 编写单元测试覆盖边界条件

##### TSK2.1.1D：后端：实现酒店查询接口

工作内容：

- 实现`/api/hotel/query`
- 要求将查询过程模块化
- 对于每个模块，编写单元测试覆盖边界条件

##### TSK2.1.1E：前端：编写酒店次查询页面

工作内容：

- 选择“酒店”选项卡，应当切换到酒店预订界面
- 在搜索框左侧，应当能选择目的城市/目的火车站
  - 应当能通过下拉列表直接选择，
  - 并且能输入拼音首字母、拼音全拼、中文进行搜索
  - 下拉列表应当包含省->城市结构
- 在搜索框中，可输入酒店名称进行搜索
  - 应当允许搜索框中不输入任何内容
  - 应当在未输入内容时，在搜索框中以默认文字提示用户可以不输入内容直接搜索
- 查询结果默认应当按评分排序
- 查询结果界面默认应当包含如下内容：
  - 排序条件：按评分、按价格、按订购人次
  - 筛选条件：
    - 住宿时间：起始--结束（最长不超过 7 天）
  - 酒店概览信息：
    - 酒店名称
    - 酒店图片
    - 酒店评分以及评分人数
    - 酒店累计预订人次
    - 酒店价格
- 点击查询结果中的酒店，应当跳转到对应酒店的详情界面，并向相应组件传递筛选条件
- 酒店列表应当分页，并能选择每页展示数量
- 空结果时显示友好提示
- 请求发送以及错误处理

#### US2.1.2 作为旅客，我想查看选定酒店的详细信息，以便进行对比并选择是否预订

验收标准：

- 查询酒店后，点击任意查询到的酒店，应当进入酒店详情界面
- 酒店详情界面应当包含如下信息：
  - 酒店名称
  - 酒店详细地址
  - 联系电话
  - 酒店评分以及评分人数
  - 酒店累计预订人次
  - 用户留言
    - 用户名
    - 留言时间
    - 评分
    - 留言内容
  - 对于每个房间类型（优先显示“查询酒店”时筛选的房间类型（若有），住宿时间默认按照“查询酒店”时选定的设置）：
    - 类型名称
    - 可入住人数
    - 剩余数量
    - 价格
    - 预订按钮
- 用户应当能随时访问预订列表（详见 US2.1.3）

##### TSK2.1.2A：后端：实现酒店详情、预订详情查询

工作内容：

- 实现`/api/hotel/info/{hotel_id}`
- 实现`/api/hotel/order_info`

##### TSK2.1.2B：前端：实现酒店详情页面

工作内容：

- 酒店详情界面应当包含如下信息：
  - 酒店名称
  - 酒店详细地址
  - 联系电话
  - 酒店评分以及评分人数
  - 酒店累计预订人次
  - 对于每个房间类型（住宿时间默认按照“查询酒店”时选定的设置，即，接收并处理传递的筛选条件）：
    - 类型名称
    - 可入住人数
    - 剩余数量
    - 价格
    - 预订按钮
  - 用户留言
    - 用户名
    - 留言时间
    - 评分
    - 留言内容
  - 用户留言应当分页显示，并能选择每页展示数量
- 提供展开预订列表的按钮（详见 US2.1.3）

#### US2.1.3 作为旅客，我想能方便地为自己和同行的人预订酒店，以便安排行程

验收标准：

- 在酒店详情页面点击“预订按钮”后，应弹出“预订”悬浮窗
  - 在悬浮窗中，应当能设置住宿时间
  - 提供两个按钮：继续添加房间、确认预订信息；点击任意按钮后，该房间应加入预订列表，悬浮窗应当关闭
    - 点击“继续添加房间”按钮后，用户可以继续选择其它房间进行预订
    - 点击“确认预订信息”按钮后，跳转至提交订单界面，需包含已在预订列表中的所有添加的房间
  - 提供关闭按钮，点击后悬浮窗关闭，不添加房间至预订列表中
- 在悬浮窗中预订的信息，应当保存到类似网购平台“购物车”的预订列表中
- 点击预订列表图标，可以悬浮窗或侧边栏的方式显示预订列表，其中应当包含如下信息：
  - 对于每个房间
    - 房间类别
    - 旅客姓名
    - 住宿时间
    - 价格
  - 总价
  - 提交订单按钮
- 用户应当能从预订列表中移除预订项目（或者勾选）
- 提交订单后，应进入订单支付流程
- 注：预订列表**不要求**后端保存，但应当在切换页面、刷新页面后仍能保留（参考：Local Storage）

##### TSK2.1.3A：后端：酒店预订

工作内容：

- 实现`/api/hotel/order`
- 检查订单是否合法
- 当交易支付后，触发：
  - 单笔订单处理
  - 多笔订单处理
  - 失败回滚
  - 退款逻辑
- 对于每个模块，编写单元测试覆盖边界条件

##### TSK2.1.3B：前端：酒店预订

工作内容：

- 在酒店详情页面点击“预订按钮”后，应弹出“预订”悬浮窗
- 显示已添加的旅客信息，允许一键加入预订订单
  - 用户登录/修改旅客信息时，保存/更新前端全局状态，避免反复调用 API 查询
  - 在悬浮窗中，应当能设置住宿时间
  - 提供两个按钮：继续添加房间、确认预订信息；点击任意按钮后，该房间应加入预订列表，悬浮窗应当关闭
    - 点击“继续添加房间”按钮后，用户可以继续选择其它房间进行预订
    - 点击“确认预订信息”按钮后，跳转至提交订单界面，需包含已在预订列表中的所有添加的房间
  - 提供关闭按钮，点击后悬浮窗关闭，不添加房间至预订列表中

##### TSK2.1.3C：前端：预订列表管理

工作内容：

- 在“预订”悬浮窗中预订的信息，应当保存到类似网购平台“购物车”的预订列表中
- 点击预订列表图标，可以悬浮窗或侧边栏的方式显示预订列表，其中应当包含如下信息：
  - 对于每个房间
    - 房间类别
    - 旅客姓名
    - 住宿时间
    - 价格
  - 总价
  - 提交订单按钮
- 用户应当能从预订列表中移除预订项目（或者勾选）
- 即使用户刷新网页、关闭并再打开浏览器，预订列表中的内容也不应当丢失（参考：Local Storage）
- 当预订列表更新时，应当即使更新本地存储中的预订列表
- 提交订单后，应进入订单支付流程
- 发送预订请求以及错误处理
  - 若请求成功，将收到交易 ID，以此显示支付界面
  - 若请求失败，提示用户稍后再试

#### US2.1.4 作为旅客，我想按通用的方式完成所有类型订单的处理，以减轻心智负担

验收标准：

- 酒店预订订单的处理流程和火车票预订相同

#### US2.1.5 作为旅客，我想能对住过的酒店进行评价，以便其它旅客参考

验收标准：

- 在酒店详情页面，应当有“撰写评价”按钮
- 应当只有住过该酒店的用户，才能为该酒店撰写评价（撰写评价按钮为可点击状态）
- 若用户不能撰写评价，撰写评价按钮应为不可点击状态，并显示不能撰写评价的原因
- 评价应当包含评分（0 到 5 之间的实数）以及评论（文本，最多 1024 字节）
- 对于每个用户，其有多少个该酒店的已完成订单（按订单数量计算），则可以撰写对应条数的评价

##### TSK2.1.5A：后端：实现撰写评价功能

工作内容：

- 实现`/api/hotel/quota/{hotel_id}`
- 实现`/api/hotel/comment`

##### TSK2.1.5B：前端：实现撰写评价功能

工作内容：

- 在酒店详情的用户评价部分的适当位置，展示“撰写评价”按钮
- 根据用户当前是否可以撰写平均，更改“撰写评价”按钮的状态
- 点击“撰写评价”按钮，弹出“评价”悬浮窗：
  - 显示用户可撰写评价的条数
  - 允许用户选择评分（检查合法性，或直接用图形方式让用户选择）
  - 允许用户撰写评价内容（显示当前字节数以及字节数上限）
  - 提交评价按钮
- 请求发送及错误处理

### FE2.2：火车餐服务（5 天）

功能点：

- 查询：查看对应班次可选的火车餐
- 火车餐预订：对应到车次，支持用餐时间选择（时间是否合法？）
- 外卖预订：对应到车次、车站，分不同商家提供
- 整合之前的订单管理系统

#### US2.2.1：作为旅客，我想查看火车餐，以便决定是否预订

验收标准：

- 在首页展示火车餐预订的入口，点击后进入“火车餐预订”界面
- 火车餐预订界面支持按车次查询、按起始到达站查询
- 火车餐预订界面应当包含如下信息：
  - 车次
  - 始发时间、到达时间
  - 用餐时间选择：日期
  - 选择类别：
    - 火车餐 -> 选择时段（午餐、晚餐）
    - 外卖 -> 选择起终点（不选择则默认查询从起始站到到达站的全部站点）
  - 对于每个可选的**火车餐**：
    - 名称
    - 类别（主食、饮料、零食）
    - 图片
    - 价格
    - 预订按钮
      - 若用户有该车次的车票，则可以点餐，预订按钮为可以点击状态
      - 若用户无该车次的车票，则不能点餐，预订按钮为不可点击状态，且鼠标悬停时显示不可点餐原因
  - 对于每个可选的**外卖**：
    - 店铺名称
    - 所在车站
    - 菜品列表（点击进入详情页查看）
      - 菜品名称
      - 菜品类别（主食、饮料、零食）
      - 菜品图片
      - 菜品价格
      - 预订按钮
        - 若用户有该车次的车票，则可以点餐，预订按钮为可以点击状态
        - 若用户无该车次的车票，则不能点餐，预订按钮为不可点击状态，且鼠标悬停时显示不可点餐原因

##### TSK2.2.1A：搜集/建立数据

工作内容：

- 搜集/建立如下数据（可使用实际数据，或编写数据）：
  - 火车餐：至少 20 个
  - 外卖商户：至少 10 个
  - 外卖：每个外卖商户至少 1 个，合计至少 20 个
- 信息保存要求用 JSON 格式，并符合`./RFC/attachment/RFC3/TSK2.2.1A.ts`（Typescript）中的要求
  - 对于 Typescript 中的每个 schema，要求使用单独的 JSON 文件保存，例如：`type CitySchema = xxx`的对应内容保存到`city.json`中

##### TSK2.2.1B：后端：火车餐及外卖系统基本模型与接口

工作内容：

- 建立数据库`dish`表的模型
- 建立数据库`takeaway_shop`表的模型
- 建立数据库`takeaway_dish`表的模型
- 建立上述表之间的关系
- 实现如下操作：
  - 添加火车餐、删除火车餐
  - 添加外卖商户、删除外卖商户
  - 添加外卖、删除外卖
  - 预订火车餐、取消预订火车餐
  - 预订外卖、取消预订外卖
- 注意删除需判断是否破坏参照完整性，并允许通过参数递归删除
- 能加载 TSK2.2.1A 中的数据，并能增量加载
- 编写单元测试覆盖边界条件

##### TSK2.1.1C：后端：实现火车餐及外卖查询接口

工作内容：

- 实现`/api/dish/query_by_train_number`
- 实现`/api/dish/query_by_station`
- 要求将查询过程模块化
- 对于每个模块，编写单元测试覆盖边界条件

##### TSK2.1.1D：前端：编写火车餐查询页面

工作内容：

- 在首页展示火车餐预订的入口，点击后进入“火车餐预订”界面
- 火车餐预订界面支持按车次查询、按起始到达站查询
- 火车餐预订界面应当包含如下信息：
  - 车次
  - 始发时间、到达时间
  - 用餐时间选择：日期
  - 选择类别：
    - 火车餐 -> 选择时段（午餐、晚餐）
    - 外卖 -> 选择起终点（不选择则默认查询从起始站到到达站的全部站点）
  - 对于每个可选的**火车餐**：
    - 名称
    - 类别（主食、饮料、零食）
    - 图片
    - 价格
    - 预订按钮
      - 若用户有该车次的车票，则可以点餐，预订按钮为可以点击状态
      - 若用户无该车次的车票，则不能点餐，预订按钮为不可点击状态，且鼠标悬停时显示不可点餐原因
  - 对于每个可选的**外卖**：
    - 店铺名称
    - 所在车站
    - 菜品列表（点击进入详情页查看）
      - 菜品名称
      - 菜品类别（主食、饮料、零食）
      - 菜品图片
      - 菜品价格
      - 预订按钮
        - 若用户有该车次的车票，则可以点餐，预订按钮为可以点击状态
        - 若用户无该车次的车票，则不能点餐，预订按钮为不可点击状态，且鼠标悬停时显示不可点餐原因
- 火车餐列表应当分页，并能选择每页展示数量
- 空结果时显示友好提示
- 请求发送以及错误处理

#### US2.2.2：作为旅客，我想预订火车餐，以便解决饮食问题

验收标准：

- 在火车餐预订页面点击“预订按钮”后，应弹出“预订”悬浮窗
  - 在悬浮窗中，应当能设置用餐人、份数
  - 提供两个按钮：继续添加、确认点餐；点击任意按钮后，该火车餐应加入预订列表，悬浮窗应当关闭
    - 点击“继续添加”按钮后，用户可以继续选择其它火车餐进行预订
    - 点击“确认点餐”按钮后，跳转至提交订单界面，需包含已在预订列表中的所有添加的火车餐
  - 提供关闭按钮，点击后悬浮窗关闭，不添加火车餐至预订列表中
- 在悬浮窗中预订的信息，应当保存到类似网购平台“购物车”的预订列表中
- 点击预订列表图标，可以悬浮窗或侧边栏的方式显示预订列表，其中应当包含如下信息：
  - 对于每个用餐人
    - 火车餐名称
    - 单价
    - 份数（用户应当能调整份数）
    - 单项总价
  - 总价
  - 提交订单按钮
- 用户应当能从预订列表中移除预订项目（或者勾选）
- 提交订单界面应当可以选择具体的用餐时间段
  - 对于火车餐，只能选择午餐/晚餐（若适用）
  - 对于外卖，为商户对应的车站，不可修改
- 提交订单后，应进入订单支付流程
- 注：预订列表**不要求**后端保存，但应当在切换页面、刷新页面后仍能保留（参考：Local Storage）

##### TSK2.2.2A：后端：火车餐及外卖预订

工作内容：

- 实现`/api/dish/order`
- 检查订单是否合法
- 当交易支付后，触发：
  - 单笔订单处理
  - 多笔订单处理
  - 失败回滚
  - 退款逻辑
- 对于每个模块，编写单元测试覆盖边界条件

##### TSK2.2.2B：前端：火车餐及外卖预订

工作内容：

- 在火车餐预订页面点击“预订按钮”后，应弹出“预订”悬浮窗
  - 在悬浮窗中，应当能设置用餐人、份数
  - 提供两个按钮：继续添加、确认点餐；点击任意按钮后，该火车餐应加入预订列表，悬浮窗应当关闭
    - 点击“继续添加”按钮后，用户可以继续选择其它火车餐进行预订
    - 点击“确认点餐”按钮后，跳转至提交订单界面，需包含已在预订列表中的所有添加的火车餐
  - 提供关闭按钮，点击后悬浮窗关闭，不添加火车餐至预订列表中
- 在悬浮窗中预订的信息，应当保存到类似网购平台“购物车”的预订列表中
- 点击预订列表图标，可以悬浮窗或侧边栏的方式显示预订列表，其中应当包含如下信息：
  - 对于每个用餐人
    - 火车餐名称
    - 单价
    - 份数（用户应当能调整份数）
    - 单项总价
  - 总价
  - 提交订单按钮
- 用户应当能从预订列表中移除预订项目（或者勾选）
- 提交订单界面应当可以选择具体的用餐时间段
  - 对于火车餐，只能选择午餐/晚餐（若适用）
  - 对于外卖，为商户对应的车站，不可修改
- 提交订单后，应进入订单支付流程

##### TSK2.2.2C：前端：预订列表管理

工作内容：

- 在“预订”悬浮窗中预订的信息，应当保存到类似网购平台“购物车”的预订列表中
- 点击预订列表图标，可以悬浮窗或侧边栏的方式显示预订列表，其中应当包含如下信息：
  - 对于每个用餐人
    - 火车餐名称
    - 单价
    - 份数（用户应当能调整份数）
    - 单项总价
  - 总价
  - 提交订单按钮
- 提交订单界面应当可以选择具体的用餐时间段
  - 对于火车餐，只能选择午餐/晚餐（若适用）
  - 对于外卖，为商户对应的车站，不可修改
- 用户应当能从预订列表中移除预订项目（或者勾选）
- 即使用户刷新网页、关闭并再打开浏览器，预订列表中的内容也不应当丢失（参考：Local Storage）
- 当预订列表更新时，应当即使更新本地存储中的预订列表
- 提交订单后，应进入订单支付流程
- 发送预订请求以及错误处理
  - 若请求成功，将收到交易 ID，以此显示支付界面
  - 若请求失败，提示用户稍后再试

#### US2.2.3 作为旅客，我想按通用的方式完成所有类型订单的处理，以减轻心智负担

验收标准：

- 火车餐预订订单的处理流程和火车票预订相同

### FE2.3：完善通知功能（3 天）

功能点：

- 显示订购成功/失败、取消订购成功/失败、火车发车提示
- 查看历史通知

#### US2.3.1：作为乘客，我想得知订单是否成功，以便于安排行程

验收标准：

- 当出现订购成功/失败、取消订购成功/失败事件时，在页面上显示通知（无论当前正在浏览哪个部分）
- 当天有行程时，在页面上显示通知（无论当前正在浏览哪个部分），首页增加组件展示

##### US2.3.1A：后端：通知基本功能实现

工作内容：

- 建立数据库`message`表的模型
- 记录将发送给用户的所有通知并保存到`message`表中
- 实现如下操作：
  - 向特定用户发送通知
  - 向所有用户发送通知
  - 获取特定用户的历史通知
- 编写单元测试覆盖边界条件

##### US2.3.1B：后端：订购通知及行程通知实现

工作内容：

- 实现 HTTP 端点：`GET /api/notify/endpoint`
- 实现 WebSocket 消息：订购通知
- 实现 WebSocket 消息：行程通知

##### US2.3.1C：前端：通知接收与展示

工作内容：

- 获取 WebSocket 端点的地址
- 建立 WebSocket 连接
  - 连接异常处理：连接异常中断时，尝试重连，并通过消息告知用户
- 接收并解析 WebSocket 消息
- 当收到通知时，以较为醒目的方式展示在屏幕上，无论用户当前正在哪个页面

#### US2.3.2：作为乘客，我想查看历史通知，以便于回顾行程

验收标准：

- 当用户点击标题栏中的“消息”按钮时，可进入历史消息界面
- 历史消息界面应当包含如下内容：
  - 筛选条件
    - 日期范围
    - 消息类型：订单通知、行程通知
  - 消息列表：按时间排序
    - 对于每条消息：
      - 消息类别
      - 消息标题
      - 发送时间
      - 消息内容

##### US2.3.2A：后端：历史通知实现

工作内容：

- 实现`/api/notify/history`

##### US2.3.2B：前端：历史通知界面

工作内容：

- 当用户点击标题栏中的“消息”按钮时，可进入历史消息界面
- 历史消息界面应当包含如下内容：
  - 筛选条件
    - 日期范围
    - 消息类型：订单通知、行程通知
  - 消息列表：按时间排序
    - 对于每条消息：
      - 消息类别
      - 消息标题
      - 发送时间
      - 消息内容
- 消息列表应当分页，并能选择每页展示数量
- 空结果时显示友好提示
- 请求发送以及错误处理

## EP3：实现智能换乘推荐系统（1 周）

价值：解决复杂出行需求，提升订单转化率。
范围：火车换乘、智能行程推荐（智能推荐火车餐、目的地酒店等）

### FE3.1：火车换乘功能（4 天）

功能点：

- 实现经过一次中转的换乘查询：
  - 支持在同一个站内换乘、同城换乘、座位换乘
  - 实现换乘时间估计函数$f(A, B)$，估计从 A 站下车，到 B 站上车需要的时间
  - 根据$f(A, B)$判断时间上能否安全地完成换乘
- 排序：旅途总时长、出发时间早晚、价格

#### US3.1.1：作为乘客，我想换乘查询请求能返回需要的信息，并够快速得到响应，以便于合理规划

验收标准：

- 选择“火车票”选项卡，应当切换到火车票购票界面
- 选择“中转”选项，进入中转查询模式
- 选择起始站、到达站、出发时间并点击查询后，响应时间<1s
- 选择起始城市、到达城市、出发时间并点击查询后，响应时间<1s
- 查询结果界面应当包含如下内容：
  - 筛选选项：只看高铁/动车、只看普通车、只看有票
  - 排序选项：按出发时间、按行程时间、按价格
  - 车次信息：
    - 第一程：起始站、离开“起始站”时间；到达站、到达“终到站”时间；第二程：起始站、离开“起始站”时间；到达站、到达“终到站”时间
    - 中间换乘可用的时间
    - 第一程车次号、第二程车次号
    - 第一程行程时间、第二程行程时间，全程时间
    - 价格（两程各自余票的最低票价之和）
    - 剩余座位信息：
      - 对于每一程：
        - 每种座位类型的剩余数量，每种座位的价格
        - 对于剩余数量>20% 的，显示为有票（绿色字体）；<20% 的，显示为剩余张数（黄色字体）；无剩余座位的，显示为无票（红色字体）
    - 预订按钮

##### US3.1.1A：后端：换乘基本功能

工作内容：

- 实现如下功能：
  - 给定起始站、到达站，查询最多经过一次换乘的换乘方案
  - 实现换乘时间估计函数$f(A, B)$，估计从 A 站下车，到 B 站上车需要的时间
- 要求将功能实现过程模块化
- 对于每个模块，编写单元测试覆盖边界条件

##### US3.1.1B：后端：换乘查询接口实现

工作内容：

- 实现`/api/train/schedule/query_indirect`

##### US3.1.1C：前端：编写换乘查车次询页面

工作内容：

- 选择“火车票”选项卡，应当切换到火车票购票界面
- 选择“中转”选项，进入中转查询模式
- 实现选择起始站、到达站、起始城市、到达城市的功能：应当有输入框，并有下拉菜单
  - 应当能按拼音首字母、拼音全拼、中文筛选，下拉菜单实时显示符合筛选条件的内容
  - 下拉菜单应有层次结构：（省份）->城市->（车站）
- 选择起始站、到达站、出发时间并点击查询后，响应时间<1s
- 选择起始城市、到达城市、出发时间并点击查询后，响应时间<1s
- 查询结果界面应当包含如下内容：
  - 筛选选项：只看高铁/动车、只看普通车、只看有票
  - 排序选项：按出发时间、按行程时间、按价格
  - 车次信息：
    - 第一程：起始站、离开“起始站”时间；到达站、到达“终到站”时间；第二程：起始站、离开“起始站”时间；到达站、到达“终到站”时间
    - 离开“起始站”时间、到达“到达站”时间：只显示时间，不显示日期；若跨越了一天，在到达“到达站”时间上用（+1 等上标标识，参见 12306）
    - 始发时间、终到时间：只显示时间，不显示日期；若跨越了一天，在到达“到达站”时间上用（+1 等上标标识，参见 12306）
    - 中间换乘可用的时间
    - 第一程车次号、第二程车次号
    - 第一程行程时间、第二程行程时间，全程时间
    - 行程时间：应当显示“XX 时 XX 分”，若小于 1 小时，显示“XX 分”，若大于 1 天，仍显示“XX 时 XX 分”
    - 价格（两程各自余票的最低票价之和）
    - 剩余座位信息：
      - 对于每一程：
        - 每种座位类型的剩余数量，每种座位的价格
        - 对于剩余数量>20% 的，显示为有票（绿色字体）；<20% 的，显示为剩余张数（黄色字体）；无剩余座位的，显示为无票（红色字体）
    - 预订按钮
- 车次列表应当分页，并能选择每页展示数量
- 空结果时显示友好提示
- 请求发送以及错误处理

#### US3.1.2：作为乘客，我想预订中转车票，以便于安排行程

- 在中转查询结果界面，点击“预订”按钮，进行火车票预订
- 在提交订单时，应默认按设置好的乘车人信息进行选择，同时允许手动修改
- 对于中转的两个车次，用户应当能单独设置座位等级，但默认应当对所有乘车人保持相同
- 若有订单部分失败（其中一个车次恰好无剩余座位），应当回滚整个操作并通知用户

##### TSK3.1.2A：前端：火车订单预订

工作内容：

- 在火车票购票界面，点击“预订”后，弹出购票悬浮窗
- 显示已添加的乘车人信息，允许一键加入预订订单
  - 用户登录/修改乘车人信息时，保存/更新前端全局状态，避免反复调用 API 查询
- 调用`/api/train/order/new`进行预订，注意请求中需要将`atomic`设为`true`
- 发送预订请求以及错误处理
  - 若请求成功，将收到交易 ID，以此显示支付界面
  - 若请求失败，提示用户稍后再试

### FE3.2：智能行程推荐（3 天）

功能点：

- 根据目的地，推荐评价较高的酒店
- 若乘坐火车的时间跨越了饭点，进行相应的火车餐推荐

#### US3.2.1：作为旅客，我想根据目的地信息，获得附近酒店的推荐，以便于安排行程

- 在“首页”，自动根据用户预订成功的火车票订单的目的地，推荐附近的酒店
- 对于每个可能的目的地：
  - 在首页中分出一栏，显示评分 ≥ 4.5 的酒店
  - 对于每个酒店，应当包含如下信息：
    - 酒店名称
    - 酒店图片
    - 酒店评分以及评分人数
    - 酒店累计预订人次
    - 酒店价格（最低价格）

##### TSK3.2.1A：后端：实现附近酒店推荐

工作内容：

- 实现`/api/hotel/recommend`

##### TSK3.2.1B：前端：展示附近酒店推荐

工作内容：

- 在“首页”，自动根据用户预订成功的火车票订单的目的地，推荐附近的酒店
- 对于每个可能的目的地：
  - 在首页中分出一栏，显示评分 ≥ 4.5 的酒店
  - 对于每个酒店，应当包含如下信息：
    - 酒店名称
    - 酒店图片
    - 酒店评分以及评分人数
    - 酒店累计预订人次
    - 酒店价格（最低价格）
  - 点击展示的酒店，应当能直接进入酒店详情页面

#### US3.2.2：作为旅客，我想根据车程安排，获得火车餐及外卖的推荐，以便于解决饮食问题

- 在“首页”，自动根据用户预订成功的火车票订单的车程，推荐火车餐及外卖
- 对于每个可能的车程：
  - 在首页中分出一栏，显示推荐的火车餐及外卖
  - 对于每个火车餐，应当包含如下信息：
    - 火车餐名称
    - 火车餐图片
    - 火车餐价格
    - 预订按钮
  - 对于每个外卖，应当包含如下信息：
    - 店铺名称
    - 所在车站
    - 菜品名称
    - 菜品图片
    - 菜品价格
    - 预订按钮

##### TSK3.2.2A：后端：实现火车餐及外卖推荐

工作内容：

- 实现`/api/dish/recommend`

##### TSK3.2.2B：前端：展示火车餐及外卖推荐

工作内容：

- 在“首页”，自动根据用户预订成功的火车票订单的车程，推荐火车餐及外卖
- 对于每个可能的车程：
  - 在首页中分出一栏，显示推荐的火车餐及外卖
  - 对于每个火车餐，应当包含如下信息：
    - 火车餐名称
    - 火车餐图片
    - 火车餐价格
    - 预订按钮
  - 对于每个外卖，应当包含如下信息：
    - 店铺名称
    - 所在车站
    - 菜品名称
    - 菜品图片
    - 菜品价格
    - 预订按钮

## EP4：提升用户体验（0-1 周）

价值：提升用户使用平台的流畅度与舒适度。
范围：页面加载速度、交互设计、视觉设计。

### FE5.1：交互设计

功能点：

- 美观的 UI 设计
- 易上手、无须过多引导的交互逻辑
- 友好的提示信息
- 响应式设计
